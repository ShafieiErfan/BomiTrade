<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت ترید اسپات</title>
    <style>
        @font-face {
            font-family: 'Estedad';
            src: url('fonts/Estedad-Black.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --input-bg: #2c2c2c;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent: #d4af37;
            --accent-hover: #b5952f;
            --success: #00c853;
            --danger: #ff3d00;
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            font-family: 'Estedad', 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .container {
                grid-template-columns: 350px 1fr;
            }
        }

        .card {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
        }

        h2, h3 {
            margin-top: 0;
            color: var(--accent);
            font-weight: 600;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        input, select {
            width: 100%;
            padding: 12px;
            background-color: var(--input-bg);
            border: 1px solid #444;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            transition: var(--transition);
            font-family: 'Estedad', sans-serif;
        }

        input:focus, select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 8px rgba(212, 175, 55, 0.2);
        }

        /* استایل دکمه آپلود عکس */
        .file-upload-wrapper {
            position: relative;
            margin-bottom: 15px;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            background-color: var(--input-bg);
            border: 1px dashed #555;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-muted);
            transition: var(--transition);
        }

        .file-upload-label:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        #imageInput {
            display: none;
        }

        #imagePreview {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            border: 1px solid #444;
        }

        .btn-submit {
            width: 100%;
            padding: 14px;
            background-color: var(--accent);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 10px;
        }

        .btn-submit:hover {
            background-color: var(--accent-hover);
            transform: translateY(-2px);
        }

        .file-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-outline {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .btn-outline:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        /* استایل جدول */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th {
            text-align: right;
            padding: 12px;
            color: var(--text-muted);
            border-bottom: 1px solid #333;
            font-size: 0.9rem;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #333;
            font-size: 0.95rem;
            vertical-align: middle;
        }

        .profit-text { color: var(--success); }
        .loss-text { color: var(--danger); }

        .btn-delete {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 1.2rem;
            transition: color 0.2s;
        }

        .btn-delete:hover { color: var(--danger); }

        /* استایل کارت خلاصه سود و ضرر */
        .summary-card {
            background: rgba(212, 175, 55, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .summary-title {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .trade-img-thumb {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #444;
        }

        /* مودال نمایش عکس */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }
        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>

<div class="container">
    <!-- بخش فرم -->
    <div class="card">
        <h2>افزودن ترید اسپات</h2>
        <form id="tradeForm">
            <div class="form-group">
                <label>نام ارز (مثلاً BTC)</label>
                <input type="text" id="coinName" placeholder="BTC" required>
            </div>

            <div class="form-group">
                <label>نوع معامله</label>
                <select id="tradeType">
                    <option value="buy">خرید (Long)</option>
                    <option value="sell">فروش (Short)</option>
                </select>
            </div>

            <div class="form-group">
                <label>قیمت ورود (دلار)</label>
                <input type="number" id="entryPrice" placeholder="0.00" step="any" required>
            </div>

            <div class="form-group">
                <label>قیمت خروج (دلار)</label>
                <input type="number" id="exitPrice" placeholder="0.00" step="any" required>
            </div>

            <div class="form-group">
                <label>حجم / مقدار</label>
                <input type="number" id="amount" placeholder="0.00" step="any" required>
            </div>

            <div class="form-group">
                <label>تاریخ معامله</label>
                <input type="date" id="tradeDate" required>
            </div>

            <!-- بخش آپلود عکس -->
            <div class="file-upload-wrapper">
                <label for="imageInput" class="file-upload-label">
                    <span id="uploadText">کلیک کنید تا عکس اضافه شود (اختیاری)</span>
                </label>
                <input type="file" id="imageInput" accept="image/*">
                <img id="imagePreview" alt="پیش‌نمایش">
            </div>

            <button type="submit" class="btn-submit">ثبت معامله</button>
        </form>

        <div class="file-controls">
            <button class="btn-outline" onclick="exportData()">خروجی JSON</button>
            <button class="btn-outline" onclick="document.getElementById('importInput').click()">بازیابی فایل</button>
            <input type="file" id="importInput" style="display: none;" accept=".json" onchange="importData(this)">
        </div>
    </div>

    <!-- بخش لیست و آمار -->
    <div class="card">
        <h2>تاریخچه معاملات</h2>

        <!-- کارت آمار -->
        <div class="summary-card">
            <div class="summary-title">درصد سود/ضرر خالص کل</div>
            <div class="summary-value" id="totalProfitPercent">۰٪</div>
        </div>

        <div class="table-responsive">
            <table id="tradeTable">
                <thead>
                <tr>
                    <th>تاریخ</th>
                    <th>ارز</th>
                    <th>نوع</th>
                    <th>ورود/خروج</th>
                    <th>سود/ضرر</th>
                    <th>عکس</th>
                    <th>عملیات</th>
                </tr>
                </thead>
                <tbody id="tradeList">
                <!-- آیتم‌ها اینجا اضافه می‌شوند -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- مودال نمایش عکس بزرگ -->
<div id="imageModal" class="modal" onclick="closeModal()">
    <span class="close-modal">&times;</span>
    <img class="modal-content" id="modalImg">
</div>

<script>
    let trades = JSON.parse(localStorage.getItem('cryptoTrades')) || [];
    let currentImageBase64 = null;

    // تنظیم تاریخ پیش‌فرض به امروز
    document.getElementById('tradeDate').valueAsDate = new Date();

    // هندل کردن انتخاب عکس و تبدیل به Base64
    document.getElementById('imageInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onloadend = function() {
                currentImageBase64 = reader.result;
                const preview = document.getElementById('imagePreview');
                preview.src = currentImageBase64;
                preview.style.display = 'block';
                document.getElementById('uploadText').innerText = file.name;
            }
            reader.readAsDataURL(file);
        }
    });

    // ثبت معامله جدید
    document.getElementById('tradeForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const entryPrice = parseFloat(document.getElementById('entryPrice').value);
        const exitPrice = parseFloat(document.getElementById('exitPrice').value);
        const amount = parseFloat(document.getElementById('amount').value);
        const type = document.getElementById('tradeType').value;

        // محاسبه سود یا ضرر
        let profitPercent = 0;
        if (type === 'buy') {
            profitPercent = ((exitPrice - entryPrice) / entryPrice) * 100;
        } else {
            profitPercent = ((entryPrice - exitPrice) / entryPrice) * 100;
        }

        const newTrade = {
            id: Date.now(),
            coin: document.getElementById('coinName').value.toUpperCase(),
            type: type,
            entry: entryPrice,
            exit: exitPrice,
            amount: amount,
            date: document.getElementById('tradeDate').value,
            image: currentImageBase64, // ذخیره رشته Base64
            profitPercent: profitPercent
        };

        trades.push(newTrade);
        saveAndRender();

        // ریست کردن فرم
        this.reset();
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('uploadText').innerText = 'کلیک کنید تا عکس اضافه شود (اختیاری)';
        currentImageBase64 = null;
        document.getElementById('tradeDate').valueAsDate = new Date();
    });

    // ذخیره در لوکال استوریج و رندر کردن
    function saveAndRender() {
        localStorage.setItem('cryptoTrades', JSON.stringify(trades));
        renderTrades();
        calculateTotalProfit();
    }

    // نمایش لیست
    function renderTrades() {
        const list = document.getElementById('tradeList');
        list.innerHTML = '';

        // مرتب‌سازی بر اساس تاریخ (جدیدترین بالا)
        const sortedTrades = [...trades].sort((a, b) => new Date(b.date) - new Date(a.date));

        sortedTrades.forEach(trade => {
            const row = document.createElement('tr');

            const profitClass = trade.profitPercent >= 0 ? 'profit-text' : 'loss-text';
            const profitSign = trade.profitPercent >= 0 ? '+' : '';
            const typeLabel = trade.type === 'buy' ? 'خرید' : 'فروش';
            const typeClass = trade.type === 'buy' ? 'badge-long' : 'badge-short';

            // ستون عکس
            let imgHtml = '<span style="color:#555">-</span>';
            if (trade.image) {
                imgHtml = `<img src="${trade.image}" class="trade-img-thumb" onclick="openModal('${trade.image}')" alt="Trade">`;
            }

            row.innerHTML = `
                <td>${trade.date}</td>
                <td><strong>${trade.coin}</strong></td>
                <td><span class="badge ${typeClass}">${typeLabel}</span></td>
                <td>
                    <div style="font-size:0.85rem">ورود: ${trade.entry}</div>
                    <div style="font-size:0.85rem">خروج: ${trade.exit}</div>
                </td>
                <td class="${profitClass}" style="font-weight:bold; direction:ltr">
                    ${profitSign}${trade.profitPercent.toFixed(2)}%
                </td>
                <td>${imgHtml}</td>
                <td>
                    <button class="btn-delete" onclick="deleteTrade(${trade.id})">&times;</button>
                </td>
            `;
            list.appendChild(row);
        });
    }

    // محاسبه درصد کل سود
    function calculateTotalProfit() {
        if (trades.length === 0) {
            document.getElementById('totalProfitPercent').innerText = '۰٪';
            document.getElementById('totalProfitPercent').style.color = 'var(--text-muted)';
            return;
        }

        // فرمول محاسبه سود مرکب: (1 + p1/100) * (1 + p2/100) ... - 1
        let totalMultiplier = 1;
        trades.forEach(t => {
            totalMultiplier *= (1 + t.profitPercent / 100);
        });

        const totalPercent = (totalMultiplier - 1) * 100;
        const el = document.getElementById('totalProfitPercent');
        el.innerText = (totalPercent >= 0 ? '+' : '') + totalPercent.toFixed(2) + '%';
        el.style.color = totalPercent >= 0 ? 'var(--success)' : 'var(--danger)';
    }

    // حذف ترید
    function deleteTrade(id) {
        if(confirm('آیا از حذف این معامله مطمئن هستید؟')) {
            trades = trades.filter(t => t.id !== id);
            saveAndRender();
        }
    }

    // خروجی گرفتن
    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(trades));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "trades_backup.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    // بازیابی فایل
    function importData(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedTrades = JSON.parse(e.target.result);
                if (Array.isArray(importedTrades)) {
                    if(confirm('آیا می‌خواهید داده‌های فعلی را با فایل جایگزین کنید؟')) {
                        trades = importedTrades;
                        saveAndRender();
                    }
                } else {
                    alert('فرمت فایل نامعتبر است.');
                }
            } catch (err) {
                alert('خطا در خواندن فایل.');
            }
        };
        reader.readAsText(file);
    }

    // مودال عکس
    function openModal(src) {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImg');
        modal.style.display = "flex";
        modalImg.src = src;
    }

    function closeModal() {
        document.getElementById('imageModal').style.display = "none";
    }

    // اجرای اولیه
    renderTrades();
    calculateTotalProfit();
</script>

</body>
</html>