<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨ÙˆÙ…ÛŒâ€ŒØªØ±ÛŒØ¯ | Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø±Ø§ÛŒÛŒ</title>
    <style>
        /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙÙˆÙ†Øª Ùˆ Ù…ØªØºÛŒØ±Ù‡Ø§ (Ù‡Ù…Ø§Ù†Ù†Ø¯ Ù†Ù…ÙˆÙ†Ù‡) */
        @font-face {
            font-family: 'Estedad';
            src: url('fonts/Estedad-Black.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        :root {
            --bg-color: #0f0f0f;
            --card-bg: #1a1a1a;
            --text-main: #ffffff;
            --text-muted: #b0b0b0;
            --accent: #d4af37; /* Ø·Ù„Ø§ÛŒÛŒ */
            --accent-hover: #f9ce48;
            --success: #00c853;
            --danger: #ff3d00;
            --glass-bg: rgba(20, 20, 20, 0.85);
            --border-color: rgba(255, 255, 255, 0.1);
        }
        * { box-sizing: border-box; outline: none; scroll-behavior: smooth; }
        body {
            font-family: 'Estedad', Tahoma, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* --- Ù‡Ø¯Ø± Ùˆ Ù†Ø§ÙˆØ¨Ø±ÛŒ --- */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            padding: 20px 0;
            transition: 0.4s;
            background: transparent;
        }
        header.scrolled {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--accent);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo span { color: white; }
        nav ul {
            display: flex;
            list-style: none;
            gap: 30px;
            margin: 0;
            padding: 0;
        }
        nav a {
            color: var(--text-main);
            text-decoration: none;
            font-weight: 500;
            transition: 0.3s;
            position: relative;
        }
        nav a:hover { color: var(--accent); }
        nav a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -5px;
            right: 0;
            background: var(--accent);
            transition: 0.3s;
        }
        nav a:hover::after { width: 100%; }

        /* --- Ø¨Ø®Ø´ Ø§ØµÙ„ÛŒ (Hero) --- */
        .hero {
            height: 60vh; /* Ú©Ù…ÛŒ Ú©ÙˆØªØ§Ù‡â€ŒØªØ± Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ø´ØªÙ† ÙØ¶Ø§ÛŒ Ø¨ÛŒØ´ØªØ± Ø¨Ø±Ø§ÛŒ Ù…Ø­ØªÙˆØ§ */
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1611974765270-ca12586343bb?q=80&w=1920&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 0 20px;
            position: relative;
        }
        .hero-content {
            max-width: 800px;
            animation: fadeInUp 1s ease-out;
        }
        .hero h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #fff, var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .hero p {
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-bottom: 30px;
        }
        .btn {
            padding: 12px 35px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            transition: 0.3s;
            display: inline-block;
            cursor: pointer;
            border: none;
        }
        .btn-primary {
            background: var(--accent);
            color: #000;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
        }
        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-3px);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.6);
        }

        /* --- Ø§Ø³ØªØ§ÛŒÙ„ Ø³ÙØ§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ù¾ÙˆØª ØªØµÙˆÛŒØ± --- */
.custom-file-upload {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 48px; /* Ù‡Ù…â€ŒØ§Ø±ØªÙØ§Ø¹ Ø¨Ø§ Ø§ÛŒÙ†Ù¾ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± */
    background: #0f0f0f;
    border: 1px dashed var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--text-muted);
    font-size: 0.9rem;
    gap: 10px;
}

.custom-file-upload:hover {
    border-color: var(--accent);
    background: rgba(212, 175, 55, 0.05);
    color: var(--accent);
}

/* Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ù¾ÙˆØª Ø§ØµÙ„ÛŒ */
.custom-file-upload input[type="file"] {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
    z-index: 2;
}

/* Ø¢ÛŒÚ©ÙˆÙ† Ø¢Ù¾Ù„ÙˆØ¯ */
.upload-icon {
    font-size: 1.2rem;
    transition: transform 0.3s;
}

.custom-file-upload:hover .upload-icon {
    transform: translateY(-2px);
}
        /* --- Ø¨Ø®Ø´ Ø¢Ù…Ø§Ø± (PNL) --- */
        .stats-section {
            padding: 60px 20px;
            background: var(--bg-color);
            position: relative;
            margin-top: -50px; /* ØªØ¯Ø§Ø®Ù„ Ø²ÛŒØ¨Ø§ Ø¨Ø§ Ù‡ÛŒØ±Ùˆ */
            z-index: 10;
        }
        .section-title {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 40px;
            color: var(--accent);
        }
        .stats-grid {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
        }
        .stat-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            text-align: center;
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), transparent);
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border-color: var(--accent);
        }
        .stat-label {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--text-main);
        }
        .stat-value.profit { color: var(--success); text-shadow: 0 0 10px rgba(0,200,83,0.3); }
        .stat-value.loss { color: var(--danger); text-shadow: 0 0 10px rgba(255,61,0,0.3); }

        /* --- Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ Ù…Ø­ØªÙˆØ§ --- */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 40px;
        }

        /* --- ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† --- */
        .form-card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-muted);
        }
        input, select {
            padding: 12px;
            background: #0f0f0f;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: white;
            font-family: inherit;
            transition: 0.3s;
        }
        input:focus, select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.2);
        }
        .btn-submit {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }
        .btn-submit:hover {
            background: var(--accent-hover);
        }
        .backup-actions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
        }
        .btn-outline:hover {
            background: var(--accent);
            color: #000;
        }

        /* --- Ø¬Ø¯ÙˆÙ„ Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ --- */
        .table-responsive {
            overflow-x: auto;
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            min-width: 800px;
        }
        th, td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }
        th {
            background: #222;
            color: var(--accent);
            font-weight: bold;
        }
        tr:hover {
            background: rgba(255,255,255,0.02);
        }
        .asset-img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 8px;
            background-color: #333;
        }
        .btn-delete {
            background: rgba(255, 61, 0, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: 0.3s;
        }
        .btn-delete:hover {
            background: var(--danger);
            color: white;
        }

        /* --- ÙÙˆØªØ± --- */
        footer {
            background: #000;
            padding: 40px 20px;
            text-align: center;
            border-top: 1px solid var(--border-color);
            margin-top: 60px;
        }
        footer p { color: #666; margin: 0; }

        /* --- Toast Notification --- */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            border: 1px solid var(--accent);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 2000;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        button {
            font-family: 'Estedad';
        }
        
        /* --- Ø§Ù†ÛŒÙ…ÛŒØ´Ù†â€ŒÙ‡Ø§ --- */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- ÙˆØ§Ú©Ù†Ø´â€ŒÚ¯Ø±Ø§ --- */
        @media (max-width: 768px) {
            .hero h1 { font-size: 2rem; }
            .nav-container { flex-direction: column; gap: 15px; }
            nav ul { gap: 15px; font-size: 0.9rem; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }

    </style>
</head>
<body>

    <!-- Ù‡Ø¯Ø± -->
    <header id="mainHeader">
        <div class="nav-container">
            <a href="#" class="logo">ğŸ“ˆ <span>Ø¨ÙˆÙ…ÛŒâ€ŒØªØ±ÛŒØ¯</span></a>
            <nav>
                <ul>
                    <li><a href="#stats">Ø¢Ù…Ø§Ø± Ø¹Ù…Ù„Ú©Ø±Ø¯</a></li>
                    <li><a href="add.html">Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø¹Ø§Ù…Ù„Ù‡</a></li>
                    <li><a href="data.html">Ù…Ø¹Ø§Ù…Ù„Ø§Øª</a></li>
                    <li><a href="scalpCalc.html">Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨</a></li>
                    <li><a href="vloume.html">Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø¬Ù…</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Ø¨Ø®Ø´ Ø§ØµÙ„ÛŒ (Hero) -->
    <!-- <section class="hero">
        <div class="hero-content">
            <h1>Ù…Ø¯ÛŒØ±ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§</h1>
            <p>Ø«Ø¨Øª Ùˆ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø·Ù„Ø§ØŒ Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„ Ùˆ Ù†Ù‚Ø±Ù‡ Ø¨Ø§ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø§Ø²Ø§Ø±</p>
            <a href="#add-asset" class="btn btn-primary">Ø«Ø¨Øª Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø¬Ø¯ÛŒØ¯</a>
        </div>
    </section> -->

    <!-- Ø¨Ø®Ø´ Ø¢Ù…Ø§Ø± (PNL) -->
    <section id="stats" style="margin: 100px 0;" class="stats-section">
        <h2 class="section-title">ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒ Ù¾ÙˆØ±ØªÙÙˆÛŒ</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Ø§Ø±Ø²Ø´ Ú©Ù„ ÙØ¹Ù„ÛŒ</div>
                <div class="stat-value" id="totalCurrentValue">Û°</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡</div>
                <div class="stat-value" id="totalInvested">Û°</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† Ø®Ø§Ù„Øµ</div>
                <div class="stat-value" id="totalPnl">Û°</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Ø¯Ø±ØµØ¯ Ø¨Ø§Ø²Ø¯Ù‡ÛŒ</div>
                <div class="stat-value" id="totalPercent">Û°Ùª</div>
            </div>
        </div>
    </section>

    <!-- Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ -->
    <div class="main-container">
        
        <!-- ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ø±Ø§ÛŒÛŒ -->
        <section id="add-asset" class="form-card">
            <h2 style="color: var(--accent); margin-top: 0;">Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø¬Ø¯ÛŒØ¯</h2>
            <form id="assetForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="assetName">Ù†Ø§Ù… Ø¯Ø§Ø±Ø§ÛŒÛŒ</label>
                        <select id="assetName" required>
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                            <!-- ØªÙˆØ³Ø· JS Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="assetAmount">Ù…Ù‚Ø¯Ø§Ø± / Ø­Ø¬Ù…</label>
                        <input type="number" id="assetAmount" step="any" placeholder="Ù…Ø«Ù„Ø§ 1.5" required>
                    </div>
                    <div class="form-group">
                        <label for="assetPrice">Ù‚ÛŒÙ…Øª Ø®Ø±ÛŒØ¯ (ØªÙˆÙ…Ø§Ù†)</label>
                        <input type="number" id="assetPrice" step="any" placeholder="Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ Ø®Ø±ÛŒØ¯" required>
                    </div>
                    <div class="form-group">
                        <label for="assetDate">Ø²Ù…Ø§Ù† Ø®Ø±ÛŒØ¯</label>
                        <input type="date" id="assetDate" required>
                    </div>
                    <div class="form-group">
                        <label for="assetImage">ØªØµÙˆÛŒØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                        <label class="custom-file-upload">
                            <input type="file" id="assetImage" accept="image/*">
                            <span class="upload-icon">ğŸ“·</span>
                            <span id="fileName">Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ±...</span>
                        </label>
                    </div>
                    <button type="submit" class="btn-submit">Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ù¾ÙˆØ±ØªÙÙˆÛŒ</button>
                </div>

                <div class="backup-actions">
                    <button type="button" id="btnBackup" class="btn-outline">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† (JSON)</button>
                    <button type="button" id="btnUploadTrigger" class="btn-outline">ğŸ“¤ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
                    <input type="file" id="fileUpload" style="display: none;" accept=".json">
                </div>
            </form>
        </section>

        <!-- Ø¬Ø¯ÙˆÙ„ Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ -->
        <section id="list">
            <h2 style="color: var(--accent);">Ù„ÛŒØ³Øª Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</h2>
            <div class="table-responsive">
                <table id="assetsTable">
                    <thead>
                        <tr>
                            <th>ØªØµÙˆÛŒØ±</th>
                            <th>Ù†Ø§Ù… Ø¯Ø§Ø±Ø§ÛŒÛŒ</th>
                            <th>Ù…Ù‚Ø¯Ø§Ø±</th>
                            <th>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®Ø±ÛŒØ¯ (ØªÙˆÙ…Ø§Ù†)</th>
                            <th>Ù‚ÛŒÙ…Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ (ØªÙˆÙ…Ø§Ù†)</th>
                            <th>Ø§Ø±Ø²Ø´ Ú©Ù„ (ØªÙˆÙ…Ø§Ù†)</th>
                            <th>Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†</th>
                            <th>Ø¯Ø±ØµØ¯ Ø±Ø´Ø¯</th>
                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- ØªÙˆØ³Ø· JS Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                    </tbody>
                </table>
            </div>
        </section>

    </div>

    <!-- ÙÙˆØªØ± -->
    <footer>
        <p>Â© Û±Û´Û°Û´ Ø¨ÙˆÙ…ÛŒâ€ŒØªØ±ÛŒØ¯ | Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§</p>
    </footer>

    <!-- Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† -->
    <div id="toast" class="toast">Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ…</div>

    <script>
        // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ ---
        const API_KEY = 'Bll5EW1kxdFEDWBseYMHTlUSmL7DdpcT';
        const API_URL_GOLD_CURRENCY = 'https://brsapi.ir/Api/Market/Gold_Currency.php?key=';
        const API_URL_COMMODITY = 'https://brsapi.ir/Api/Market/Commodity.php?key=';
        
        // Ù„ÛŒØ³Øª Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø´Ø¯Ù‡
        const SUPPORTED_ASSETS = [
            { id: 'gold_18k', name: 'Ø·Ù„Ø§ÛŒ 18 Ø¹ÛŒØ§Ø±', type: 'gold', symbol: 'IR_GOLD_18K' },
            { id: 'tether', name: 'ØªØªØ±', type: 'currency', symbol: 'USDT_IRT' },
            { id: 'bitcoin', name: 'Ø¨ÛŒØªÚ©ÙˆÛŒÙ†', type: 'crypto', symbol: 'BTC' },
            { id: 'silver', name: 'Ù†Ù‚Ø±Ù‡', type: 'commodity', symbol: 'XAGUSD' }
        ];

        let assets = [];
        let marketPrices = {};
        let lastApiFetchTime = 0;
        const API_FETCH_INTERVAL = 10 * 60 * 1000; // Û±Û° Ø¯Ù‚ÛŒÙ‚Ù‡

        // --- Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ DOM ---
        const assetForm = document.getElementById('assetForm');
        const assetNameSelect = document.getElementById('assetName');
        const assetsTableBody = document.querySelector('#assetsTable tbody');
        const toastEl = document.getElementById('toast');
        const fileUpload = document.getElementById('fileUpload');
        const header = document.getElementById('mainHeader');

        // --- Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---
        document.addEventListener('DOMContentLoaded', () => {
            loadAssetsFromStorage();
            populateAssetSelect();
            renderTable();
            
            document.getElementById('assetDate').valueAsDate = new Date();
            fetchMarketPrices();
            setInterval(fetchMarketPrices, API_FETCH_INTERVAL);

            // Ø§Ø³Ú©Ø±ÙˆÙ„ Ù‡Ø¯Ø±
            window.addEventListener('scroll', () => {
                if (window.scrollY > 50) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            });
        });

        // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ---
        function loadAssetsFromStorage() {
            const stored = localStorage.getItem('myAssets');
            if (stored) assets = JSON.parse(stored);
        }

        function saveAssetsToStorage() {
            localStorage.setItem('myAssets', JSON.stringify(assets));
        }

        // --- Ù…Ù†Ø·Ù‚ API ---
        async function fetchMarketPrices() {
            const now = Date.now();
            if (now - lastApiFetchTime < API_FETCH_INTERVAL && Object.keys(marketPrices).length > 0) return;

            try {
                const res1 = await fetch(`${API_URL_GOLD_CURRENCY}${API_KEY}`);
                const data1 = await res1.json();
                const res2 = await fetch(`${API_URL_COMMODITY}${API_KEY}`);
                const data2 = await res2.json();

                processApiData(data1, data2);
                lastApiFetchTime = now;
                savePricesToCache();
                renderTable();
                showToast('Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯');
            } catch (error) {
                console.error('API Error:', error);
                loadPricesFromCache();
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„. Ø¢Ø®Ø±ÛŒÙ† Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø´ Ø´Ø¯Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.');
            }
        }

        function processApiData(data1, data2) {
            if (data1.gold) {
                const gold18 = data1.gold.find(i => i.symbol === 'IR_GOLD_18K');
                if (gold18) marketPrices['gold_18k'] = parseFloat(gold18.price);
            }
            if (data1.currency) {
                const tether = data1.currency.find(i => i.symbol === 'USDT_IRT');
                const usd = data1.currency.find(i => i.symbol === 'USD');
                if (tether) marketPrices['tether'] = parseFloat(tether.price);
                if (usd) marketPrices['USD'] = parseFloat(usd.price);
            }
            if (data1.cryptocurrency) {
                const btc = data1.cryptocurrency.find(i => i.symbol === 'BTC');
                if (btc) marketPrices['bitcoin'] = parseFloat(btc.price);
            }
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ù‚Ø±Ù‡
            if (data2.metal_precious && marketPrices['USD']) {
                const silverOunce = data2.metal_precious.find(i => i.symbol === 'XAGUSD');
                if (silverOunce) {
                    const ouncePriceUSD = parseFloat(silverOunce.price);
                    const dollarPriceIRT = marketPrices['USD'];
                    const silverPricePerGramIRT = (ouncePriceUSD / 31.1035) * dollarPriceIRT;
                    marketPrices['silver'] = silverPricePerGramIRT;
                }
            }
        }

        function savePricesToCache() {
            localStorage.setItem('marketPricesCache', JSON.stringify({ prices: marketPrices, timestamp: Date.now() }));
        }

        function loadPricesFromCache() {
            const cached = localStorage.getItem('marketPricesCache');
            if (cached) {
                const data = JSON.parse(cached);
                marketPrices = data.prices;
                renderTable();
            }
        }

        // --- UI Helpers ---
        function populateAssetSelect() {
            SUPPORTED_ASSETS.forEach(asset => {
                const option = document.createElement('option');
                option.value = asset.id;
                option.textContent = asset.name;
                assetNameSelect.appendChild(option);
            });
        }

        function showToast(msg) {
            toastEl.textContent = msg;
            toastEl.classList.add('show');
            setTimeout(() => toastEl.classList.remove('show'), 3000);
        }

        // --- Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ø±Ø§ÛŒÛŒ ---
        assetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const assetId = document.getElementById('assetName').value;
            const amount = parseFloat(document.getElementById('assetAmount').value);
            const buyPrice = parseFloat(document.getElementById('assetPrice').value);
            const date = document.getElementById('assetDate').value;
            const imageFile = document.getElementById('assetImage').files[0];

            if (!assetId || isNaN(amount) || isNaN(buyPrice)) return showToast('Ù„Ø·ÙØ§ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ù†ÛŒØ¯');

            let imageData = null;
            if (imageFile) imageData = await toBase64(imageFile);

            assets.push({ id: Date.now(), assetId, amount, buyPrice, date, image: imageData });
            saveAssetsToStorage();
            renderTable();
            assetForm.reset();
            document.getElementById('assetDate').valueAsDate = new Date();
            showToast('Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
        });

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        window.deleteAsset = function(id) {
            if(confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                assets = assets.filter(a => a.id !== id);
                saveAssetsToStorage();
                renderTable();
                showToast('Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø­Ø°Ù Ø´Ø¯');
            }
        };

        // --- Ø±Ù†Ø¯Ø± Ø¬Ø¯ÙˆÙ„ Ùˆ PNL ---
        function renderTable() {
            assetsTableBody.innerHTML = '';
            let totalCurrentValue = 0;
            let totalInvested = 0;

            assets.forEach(asset => {
                const assetConfig = SUPPORTED_ASSETS.find(a => a.id === asset.assetId);
                const currentPrice = marketPrices[asset.assetId] || 0;
                
                const totalBuyValue = asset.amount * asset.buyPrice;
                const totalCurrentValueItem = asset.amount * currentPrice;
                const pnl = totalCurrentValueItem - totalBuyValue;
                const pnlPercent = totalBuyValue > 0 ? (pnl / totalBuyValue) * 100 : 0;

                totalInvested += totalBuyValue;
                totalCurrentValue += totalCurrentValueItem;

                const row = document.createElement('tr');
                const imgHtml = asset.image 
                    ? `<img src="${asset.image}" class="asset-img" alt="asset">` 
                    : `<div class="asset-img" style="display:flex;align-items:center;justify-content:center;font-size:10px;color:#777;">-</div>`;

                const formatMoney = (num) => num.toLocaleString('fa-IR');
                const pnlClass = pnl >= 0 ? 'profit' : 'loss';
                const pnlSign = pnl >= 0 ? '+' : '';

                row.innerHTML = `
                    <td>${imgHtml}</td>
                    <td>${assetConfig ? assetConfig.name : asset.assetId}</td>
                    <td>${asset.amount.toLocaleString('fa-IR')}</td>
                    <td>${formatMoney(asset.buyPrice)}</td>
                    <td>${currentPrice > 0 ? formatMoney(currentPrice) : '...'}</td>
                    <td>${formatMoney(totalCurrentValueItem)}</td>
                    <td class="${pnlClass}">${pnlSign}${formatMoney(pnl)}</td>
                    <td class="${pnlClass}">${pnlSign}${pnlPercent.toFixed(2)}Ùª</td>
                    <td><button class="btn-delete" onclick="deleteAsset(${asset.id})">Ø­Ø°Ù</button></td>
                `;
                assetsTableBody.appendChild(row);
            });

            updatePnlBox(totalCurrentValue, totalInvested);
        }

        function updatePnlBox(current, invested) {
            const pnl = current - invested;
            const pnlPercent = invested > 0 ? (pnl / invested) * 100 : 0;
            const pnlClass = pnl >= 0 ? 'profit' : 'loss';
            const pnlSign = pnl >= 0 ? '+' : '';

            document.getElementById('totalCurrentValue').textContent = current.toLocaleString('fa-IR');
            document.getElementById('totalInvested').textContent = invested.toLocaleString('fa-IR');
            
            const pnlEl = document.getElementById('totalPnl');
            pnlEl.textContent = `${pnlSign}${pnl.toLocaleString('fa-IR')}`;
            pnlEl.className = `stat-value ${pnlClass}`;

            const percentEl = document.getElementById('totalPercent');
            percentEl.textContent = `${pnlSign}${pnlPercent.toFixed(2)}Ùª`;
            percentEl.className = `stat-value ${pnlClass}`;
        }

        // --- Ø¨Ú©â€ŒØ¢Ù¾ ---
        document.getElementById('btnBackup').addEventListener('click', () => {
            const dataStr = JSON.stringify(assets, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `assets_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
        });

        document.getElementById('btnUploadTrigger').addEventListener('click', () => fileUpload.click());

        fileUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedAssets = JSON.parse(event.target.result);
                    if (Array.isArray(importedAssets)) {
                        assets = [...assets, ...importedAssets];
                        saveAssetsToStorage();
                        renderTable();
                        showToast('ÙØ§ÛŒÙ„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ØªØ±Ú©ÛŒØ¨ Ø´Ø¯Ù†Ø¯');
                    } else {
                        showToast('ÙØ±Ù…Øª ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                    }
                } catch (err) {
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„');
                }
                fileUpload.value = '';
            };
            reader.readAsText(file);
        });
    </script>
</body>
</html>