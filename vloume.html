<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ù¾ÛŒØ´Ø±ÙØªÙ‡ (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡)</title>
<style>
@font-face {
  font-family: 'Estedad';
  src: url('fonts/Estedad-Black.ttf') format('truetype');
}
:root {
  --bg:#121212;
  --card:#1e1e1e;
  --input:#2c2c2c;
  --text:#e0e0e0;
  --muted:#aaa;
  --accent:#d4af37;
  --success:#00c853;
  --danger:#ff3d00;
}
* { box-sizing:border-box; outline:none; }
body {
  margin:0;
  padding:20px;
  font-family:Estedad,Tahoma,sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  justify-content:center;
  min-height:100vh;
}
.container { max-width:800px; width:100%; }
.card {
  background:var(--card);
  padding:25px;
  border-radius:12px;
  border:1px solid #333;
  box-shadow:0 4px 20px rgba(0,0,0,0.4);
}
h1 { text-align:center; color:var(--accent); margin:0 0 20px 0; }
h2 { font-size:1.1rem; color:#fff; margin:15px 0 10px 0; border-bottom:1px solid #333; padding-bottom:5px; }

.input-group { margin-bottom:15px; }
label { display:block; margin-bottom:6px; color:var(--muted); font-size:0.9rem; }
input, select {
  width:100%;
  padding:12px;
  background:var(--input);
  border:1px solid #444;
  color:#fff;
  border-radius:8px;
  font-family:inherit;
}
input:focus, select:focus { border-color:var(--accent); }

.btn-row { display:flex; gap:10px; margin-top:10px; }
.btn {
  flex:1;
  padding:10px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
  font-family:inherit;
  transition:0.2s;
}
.btn-primary { background:var(--accent); color:#000; }
.btn-outline { background:transparent; border:1px solid #555; color:#ccc; }
.btn-danger { background:rgba(255,61,0,0.1); border:1px solid var(--danger); color:var(--danger); }
.btn:hover { opacity:0.9; }

.result-box {
  margin-top:25px;
  background:#181818;
  border:2px solid var(--accent);
  padding:20px;
  border-radius:12px;
  text-align:center;
}
.result-value {
  font-size:3rem;
  color:var(--accent);
  font-weight:bold;
  margin:10px 0;
}
.result-sub { color:#ccc; font-size:1rem; }
.result-detail { margin-top:15px; font-size:0.85rem; color:#888; border-top:1px solid #333; padding-top:10px; }
.result-detail div { margin-bottom:5px; }

.modal-overlay {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.85);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:1000;
}
.modal {
  background:var(--card);
  padding:30px;
  border-radius:12px;
  width:90%;
  max-width:400px;
  border:1px solid var(--accent);
  text-align:center;
}
.modal h3 { color:var(--accent); margin-top:0; }
</style>
</head>
<body>

<div class="container">
<div class="card">
  <h1>Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ù¾ÛŒØ´Ø±ÙØªÙ‡</h1>
  
  <h2>âš™ï¸ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ</h2>
  <div class="input-group">
    <label>Ø§Ø±Ø²Ø´ Ù‡Ø± ÙˆØ§Ø­Ø¯ Ù¾Ø§ÛŒÙ‡ (ØªÙˆÙ…Ø§Ù†)</label>
    <input type="number" id="baseUnitValue" value="2300000" oninput="calculate()">
    <small style="color:#666">Ù…Ø«Ù„Ø§: 2,300,000 ØªÙˆÙ…Ø§Ù†</small>
  </div>

  <div class="input-group">
    <label>Ù…Ù‚Ø¯Ø§Ø± Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ù‡Ø± ÙˆØ§Ø­Ø¯ (ØªÙˆÙ…Ø§Ù†)</label>
    <input type="number" id="stopLossPerUnit" placeholder="Ù…Ø«Ù„Ø§: 736000" oninput="calculate()">
  </div>

  <div class="input-group">
    <label>ØªØ­Ù…Ù„ Ø§Ø³ØªØ§Ù¾ Ù¾Ø´Øª Ø³Ø± Ù‡Ù… (ØªØ¹Ø¯Ø§Ø¯)</label>
    <select id="maxStops" onchange="calculate()">
      <option value="1">Û± Ø§Ø³ØªØ§Ù¾ (Ø±ÛŒØ³Ú©â€ŒÚ¯Ø±ÛŒØ²)</option>
      <option value="2">Û² Ø§Ø³ØªØ§Ù¾ (Ù…ØªØ¹Ø§Ø¯Ù„)</option>
      <option value="3" selected>Û³ Ø§Ø³ØªØ§Ù¾ (Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ)</option>
      <option value="4">Û´ Ø§Ø³ØªØ§Ù¾</option>
      <option value="5">Ûµ Ø§Ø³ØªØ§Ù¾</option>
      <option value="6">Û¶ Ø§Ø³ØªØ§Ù¾</option>
      <option value="7">Û· Ø§Ø³ØªØ§Ù¾</option>
      <option value="8">Û¸ Ø§Ø³ØªØ§Ù¾</option>
      <option value="9">Û¹ Ø§Ø³ØªØ§Ù¾</option>
      <option value="10">Û±Û° Ø§Ø³ØªØ§Ù¾ (Ø±ÛŒØ³Ú©â€ŒÙ¾Ø°ÛŒØ±)</option>
    </select>
  </div>

  <h2>ğŸ’° Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±Ù…Ø§ÛŒÙ‡</h2>
  <div class="input-group">
    <label>Ú©Ù„ Ø³Ø±Ù…Ø§ÛŒÙ‡ ÙØ¹Ù„ÛŒ (ØªÙˆÙ…Ø§Ù†)</label>
    <input type="number" id="capital" oninput="calculate()">
    <div class="btn-row">
      <button class="btn btn-outline" onclick="saveCapitalManual()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø³ØªÛŒ</button>
      <button class="btn btn-primary" onclick="syncWithJournal()">ğŸ”„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Ú˜ÙˆØ±Ù†Ø§Ù„</button>
    </div>
  </div>

  <h2>ğŸ“‚ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ</h2>
  <div class="btn-row">
    <button class="btn btn-outline" onclick="downloadSettings()">â¬‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
    <button class="btn btn-danger" onclick="document.getElementById('fileInput').click()">â¬† Ø¢Ù¾Ù„ÙˆØ¯ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
    <input type="file" id="fileInput" style="display:none" accept=".json" onchange="uploadSettings(this)">
  </div>

  <div class="result-box">
    <div>ØªØ¹Ø¯Ø§Ø¯ ÙˆØ§Ø­Ø¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯</div>
    <div class="result-value" id="resultUnits">-</div>
    <div class="result-sub" id="resultTotalValue">Ø§Ø±Ø²Ø´ Ú©Ù„ Ù¾ÙˆØ²ÛŒØ´Ù†: 0 ØªÙˆÙ…Ø§Ù†</div>
    
    <div id="statusBadge" class="status-badge" style="display:none; margin-top:10px; padding:5px 10px; border-radius:4px; font-weight:bold;"></div>

    <div class="result-detail">
      <div>ğŸ›¡ï¸ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù†Ù‚Ø¯ÛŒÙ†Ú¯ÛŒ (Û³ Ø§Ø³ØªØ§Ù¾ + Ø®Ø±ÛŒØ¯ Ù…Ø¬Ø¯Ø¯): <span id="requiredMargin" style="color:var(--danger)">0</span> ØªÙˆÙ…Ø§Ù†</div>
      <div>ğŸ“‰ Ø¶Ø±Ø± Ù‡Ø± Ù…Ø¹Ø§Ù…Ù„Ù‡: <span id="riskPerTrade">0</span> ØªÙˆÙ…Ø§Ù†</div>
      <div>ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù¾Ø³ Ø§Ø² Û³ Ø§Ø³ØªØ§Ù¾: <span id="capitalAfterStops">0</span> ØªÙˆÙ…Ø§Ù†</div>
    </div>
  </div>
</div>
</div>

<div class="modal-overlay" id="setupModal">
  <div class="modal">
    <h3>ğŸ‘‹ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h3>
    <p>Ù„Ø·ÙØ§Ù‹ Ú©Ù„ Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</p>
    <input type="number" id="initialCapitalInput" placeholder="Ù…Ø«Ù„Ø§: 10000000" style="margin-bottom:15px;">
    <button class="btn btn-primary" style="width:100%" onclick="saveInitialCapital()">Ø´Ø±ÙˆØ¹</button>
  </div>
</div>

<script>
const els = {
  baseUnitValue: document.getElementById('baseUnitValue'),
  stopLossPerUnit: document.getElementById('stopLossPerUnit'),
  maxStops: document.getElementById('maxStops'),
  capital: document.getElementById('capital'),
  resultUnits: document.getElementById('resultUnits'),
  resultTotalValue: document.getElementById('resultTotalValue'),
  requiredMargin: document.getElementById('requiredMargin'),
  riskPerTrade: document.getElementById('riskPerTrade'),
  capitalAfterStops: document.getElementById('capitalAfterStops'),
  statusBadge: document.getElementById('statusBadge'),
  setupModal: document.getElementById('setupModal'),
  initialCapitalInput: document.getElementById('initialCapitalInput')
};

document.addEventListener('DOMContentLoaded', () => {
  loadSettings();
  const savedBase = localStorage.getItem('dynBaseCapital');
  if (!savedBase) {
    els.setupModal.style.display = 'flex';
  } else {
    els.capital.value = savedBase;
    calculate();
  }
});

function parseMoney(v) {
  return parseFloat(String(v || 0).replace(/,/g, '')) || 0;
}

function saveSettings() {
  localStorage.setItem('dynBaseUnitValue', els.baseUnitValue.value);
  localStorage.setItem('dynStopLossPerUnit', els.stopLossPerUnit.value);
  localStorage.setItem('dynMaxStops', els.maxStops.value);
  localStorage.setItem('dynBaseCapital', els.capital.value);
}

function loadSettings() {
  const v1 = localStorage.getItem('dynBaseUnitValue');
  if(v1) els.baseUnitValue.value = v1;
  const v2 = localStorage.getItem('dynStopLossPerUnit');
  if(v2) els.stopLossPerUnit.value = v2;
  const v3 = localStorage.getItem('dynMaxStops');
  if(v3) els.maxStops.value = v3;
}

function calculate() {
  saveSettings();

  const capital = parseMoney(els.capital.value);
  const baseUnitVal = parseMoney(els.baseUnitValue.value);
  const stopLoss = parseMoney(els.stopLossPerUnit.value);
  const maxStops = parseInt(els.maxStops.value);

  if (capital <= 0 || baseUnitVal <= 0 || stopLoss <= 0) {
    resetDisplay();
    return;
  }

  // 1. Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ ÙˆØ§Ø­Ø¯ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø±Ø²Ø´ Ù¾Ø§ÛŒÙ‡
  let units = Math.floor(capital / baseUnitVal);
  if (units === 0 && capital >= stopLoss) units = 1; 

  // 2. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ù‚ÛŒÙ‚ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù†Ù‚Ø¯ÛŒÙ†Ú¯ÛŒ (ÙØ±Ù…ÙˆÙ„ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡)
  // Ù†ÛŒØ§Ø² Ú©Ù„ = (Ù‡Ø²ÛŒÙ†Ù‡ Ø®Ø±ÛŒØ¯ Ù…Ø¬Ø¯Ø¯) + (Ù‡Ø²ÛŒÙ†Ù‡ Ø¶Ø±Ø± Ø§Ø³ØªØ§Ù¾â€ŒÙ‡Ø§)
  // Ù‡Ø²ÛŒÙ†Ù‡ Ø®Ø±ÛŒØ¯ Ù…Ø¬Ø¯Ø¯ = units * baseUnitVal
  // Ù‡Ø²ÛŒÙ†Ù‡ Ø¶Ø±Ø± Ø§Ø³ØªØ§Ù¾â€ŒÙ‡Ø§ = units * stopLoss * maxStops
  let costToRebuy = units * baseUnitVal;
  let costOfStops = units * stopLoss * maxStops;
  let totalRequired = costToRebuy + costOfStops;

  // 3. Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù…Ù†ÛŒØª Ùˆ Ú©Ø§Ù‡Ø´ Ø­Ø¬Ù… Ø¯Ø± ØµÙˆØ±Øª Ù„Ø²ÙˆÙ…
  let isSafe = true;
  
  if (totalRequired > capital) {
    isSafe = false;
    // Ø­Ù„Ù‚Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø­Ø¯Ø§Ú©Ø«Ø± Ø­Ø¬Ù…ÛŒ Ú©Ù‡ Ø¯Ø± Ø¢Ù† Ø³Ø±Ù…Ø§ÛŒÙ‡ Ú©Ø§ÙÛŒ Ø§Ø³Øª
    while (units > 0) {
      costToRebuy = units * baseUnitVal;
      costOfStops = units * stopLoss * maxStops;
      totalRequired = costToRebuy + costOfStops;
      
      if (totalRequired <= capital) {
        break; // Ø­Ø¬Ù… Ø§Ù…Ù† Ù¾ÛŒØ¯Ø§ Ø´Ø¯
      }
      units--; // Ú©Ø§Ù‡Ø´ Ø­Ø¬Ù…
    }
    
    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ Ù¾Ø³ Ø§Ø² Ú©Ø§Ù‡Ø´ Ø­Ø¬Ù…
    costToRebuy = units * baseUnitVal;
    costOfStops = units * stopLoss * maxStops;
    totalRequired = costToRebuy + costOfStops;
  }

  const riskPerTrade = units * stopLoss;
  const remainingCapital = capital - costOfStops;

  // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
  els.resultUnits.innerText = units;
  els.resultTotalValue.innerText = `Ø§Ø±Ø²Ø´ Ú©Ù„ Ù¾ÙˆØ²ÛŒØ´Ù†: ${(units * baseUnitVal).toLocaleString()} ØªÙˆÙ…Ø§Ù†`;
  els.requiredMargin.innerText = totalRequired.toLocaleString();
  els.riskPerTrade.innerText = riskPerTrade.toLocaleString();
  els.capitalAfterStops.innerText = remainingCapital.toLocaleString();

  els.statusBadge.style.display = 'inline-block';
  if (isSafe) {
    els.statusBadge.style.background = 'rgba(0, 200, 83, 0.15)';
    els.statusBadge.style.color = 'var(--success)';
    els.statusBadge.innerText = `âœ… Ø§Ù…Ù† Ø¨Ø±Ø§ÛŒ ${maxStops} Ø§Ø³ØªØ§Ù¾`;
    els.resultUnits.style.color = 'var(--accent)';
  } else {
    els.statusBadge.style.background = 'rgba(255, 61, 0, 0.15)';
    els.statusBadge.style.color = 'var(--danger)';
    els.statusBadge.innerText = `âš ï¸ Ø­Ø¬Ù… Ú©Ø§Ù‡Ø´ ÛŒØ§ÙØª (Ú©Ù…Ø¨ÙˆØ¯ Ù…Ø§Ø±Ø¬ÛŒÙ†)`;
    els.resultUnits.style.color = 'var(--danger)';
  }
}

function resetDisplay() {
  els.resultUnits.innerText = '-';
  els.resultTotalValue.innerText = '0';
  els.requiredMargin.innerText = '0';
  els.riskPerTrade.innerText = '0';
  els.capitalAfterStops.innerText = '0';
  els.statusBadge.style.display = 'none';
}

function saveInitialCapital() {
  const val = parseMoney(els.initialCapitalInput.value);
  if (val <= 0) { alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.'); return; }
  els.capital.value = val;
  localStorage.setItem('dynBaseCapital', val);
  els.setupModal.style.display = 'none';
  calculate();
}

function syncWithJournal() {
  const raw = localStorage.getItem('goldTrades');
  if (!raw) { alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ú˜ÙˆØ±Ù†Ø§Ù„ ÛŒØ§ÙØª Ù†Ø´Ø¯.'); return; }
  try {
    const trades = JSON.parse(raw);
    let pnl = 0;
    trades.forEach(t => pnl += parseMoney(t.profit));
    const base = parseMoney(localStorage.getItem('dynBaseCapital')) || 0;
    const newCapital = base + pnl;
    els.capital.value = newCapital;
    saveSettings();
    calculate();
    alert(`âœ… Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.\nØ³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡: ${base.toLocaleString()}\nØ³ÙˆØ¯/Ø¶Ø±Ø± Ø®Ø§Ù„Øµ: ${pnl.toLocaleString()}\nØ³Ø±Ù…Ø§ÛŒÙ‡ ÙØ¹Ù„ÛŒ: ${newCapital.toLocaleString()}`);
  } catch (e) { alert('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú˜ÙˆØ±Ù†Ø§Ù„.'); }
}

function saveCapitalManual() {
  saveSettings();
  alert('âœ… Ø³Ø±Ù…Ø§ÛŒÙ‡ ÙØ¹Ù„ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.');
}

function downloadSettings() {
  const data = {
    baseUnitValue: els.baseUnitValue.value,
    stopLossPerUnit: els.stopLossPerUnit.value,
    maxStops: els.maxStops.value,
    baseCapital: els.capital.value
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'volume-settings.json';
  a.click();
}

function uploadSettings(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if(data.baseUnitValue) els.baseUnitValue.value = data.baseUnitValue;
      if(data.stopLossPerUnit) els.stopLossPerUnit.value = data.stopLossPerUnit;
      if(data.maxStops) els.maxStops.value = data.maxStops;
      if(data.baseCapital) els.capital.value = data.baseCapital;
      saveSettings();
      calculate();
      alert('âœ… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯.');
    } catch (err) { alert('ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.'); }
  };
  reader.readAsText(file);
  input.value = '';
}
</script>

</body>
</html>